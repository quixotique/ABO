#!/bin/bash

set -e
source "$SHELLBOOST/libsh/script.sh"

ensure_in_path pactl sed

user="${1?}"
home="$(eval echo "~$user")"

if [ ! -d "$home" ]; then
   echo "No home directory: $home" >&2
   exit 1
fi
if [ -z "$DISPLAY" ]; then
   echo "Variable not set: \$DISPLAY" >&2
   exit 1
fi

run sudo --login --user="$user" rm -f "$home/.Xauthority"
xauth extract - "$DISPLAY" | run sudo --login --user="$user" /bin/sh -c 'unset XAUTHORITY; xauth merge -'
unset XAUTHORITY

environment=()

pulse_server=$(pactl info | sed -ne '/^Server String: /s///p')
chmod_paths=()
case $pulse_server in
unix:/* | /*)
    environment+=("PULSE_SERVER=$pulse_server")
    path="${pulse_server#unix:}"
    path="${path%/*}"
    while [[ -w $path ]]; do
        [[ $(run chmod -c o+x "$path") ]] && chmod_paths+=("$path")
        path="${path%/*}"
    done
    ;;
esac

pipewire_socket=$(systemctl --user status pipewire.socket| sed -ne '/^ *Listen: /{s///; s/ *(.*//; p;}')
if [[ -S $pipewire_socket ]]; then
    environment+=("PIPEWIRE_RUNTIME_DIR=${pipewire_socket%/*}")
fi

run sudo --login --user="$user" "${environment[@]}"
[[ ${chmod_paths[*]} ]] && run chmod o-x "${chmod_paths[@]}"

#!/usr/bin/env python2.7
# vim: sw=4 sts=4 et fileencoding=utf8 nomod
# Copyright 2013 Andrew Bettison

'''Usage:
    pyabo chart [-f] [AL|PL|EQ]
    pyabo index [-f]
    pyabo acc [-fwW] [--width=COLUMNS] [--wide] <account> [<period>...]
    pyabo journal [-fwW] [--width=COLUMNS] [<period>...]
    pyabo balance [-faW] [--width=COLUMNS] [<when>...]
    pyabo profloss [-faW] [--width=COLUMNS] [--tag=TAG] [<period>...]
    pyabo compa <command> <word> <preword>
    pyabo -h | --help
    pyabo --version
Options:
    -h --help               Show this message
    --version               Show version and exit
    -f --force              Force re-population of transaction cache
    --tag=TAG               Only show tagged accounts
    -w --wrap               Wrap long lines
    --width=COLUMNS         Maximum line length (default from 'COLUMNS' env var)
    -W --wide               Wide output, no maximum width
    -a --all                Show all accounts
'''

import sys
import locale
import codecs
import os.path
import textwrap
import datetime
from itertools import chain

try:
    import docopt
except ImportError:
    sys.path.append(os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), '..', 'lib', 'docopt'))
    import docopt

try:
    import abo.journal
except ImportError:
    sys.path.append(os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), '..', 'lib'))
    import abo.journal
import abo.config
import abo.period
import abo.balance
import abo.cache
from abo.types import struct

def main():
    locale.setlocale(locale.LC_ALL, '')
    lang, enc = locale.getlocale()
    output_encoding = enc
    opts = docopt.docopt(__doc__, version='0.1')
    if opts['acc']:
        func = cmd_acc
    elif opts['journal']:
        func = cmd_journal
    elif opts['chart']:
        func = cmd_chart
    elif opts['index']:
        func = cmd_index
    elif opts['profloss']:
        func = cmd_profloss
    elif opts['balance']:
        func = cmd_balance
    elif opts['compa']:
        func = cmd_compa
    else:
        assert False, 'unknown command'
    config = abo.config.Config().load(opts)
    try:
        for line in func(config, opts):
            print line.encode(output_encoding)
    except InvalidArg, e:
        print unicode(e).encode(output_encoding)
        sys.exit(1)
    sys.exit(0)

_chart_cache = None
_transaction_caches = None

def chart_cache(config, opts):
    global _chart_cache
    if _chart_cache is None:
        def compile_chart():
            chart = abo.account.Chart.from_file(file(config.chart_file_path))
            for tc in transaction_caches(chart, config, opts):
                tc.get()
            return chart
        _chart_cache = abo.cache.FileCache(config, config.chart_file_path, compile_chart, config.input_file_paths, force=opts['--force'])
    return _chart_cache

def transaction_caches(chart, config, opts):
    global _transaction_caches
    if _transaction_caches is None:
        _transaction_caches = []
        for path in config.input_file_paths:
            _transaction_caches.append(abo.cache.TransactionCache(config, path, abo.journal.Journal(config, file(path), chart=chart), [config.chart_file_path], force=opts['--force']))
    return _transaction_caches

def get_chart(config, opts):
    return chart_cache(config, opts).get()

def get_transactions(chart, config, opts):
    transactions = []
    for cache in transaction_caches(chart, config, opts):
        transactions += cache.transactions()
    transactions.sort(key=lambda t: (t.date, t.who or '', t.what or '', -t.amount()))
    return transactions

def cmd_journal(config, opts):
    chart = get_chart(config, opts)
    range, bf, transactions = filter_period(chart, get_transactions(chart, config, opts), opts)
    dw = 11
    bw = config.balance_column_width()
    aw = max(len(a.shortname()) for a in chart.accounts())
    if config.output_width():
        width = max(50, config.output_width())
        aw = min(15, aw)
        pw = max(1, width - (dw + 2 + 1 + bw + 1 + 2 + 1 + aw))
    else:
        pw = 35
        width = dw + 2 + pw + 1 + bw + 1 + 2 + 1 + aw
    fmt = u'%-{dw}.{dw}s  %-{pw}.{pw}s %{bw}s %-2.2s %-.{aw}s'.format(**locals())
    yield 'JOURNAL OF TRANSACTIONS'.center(width)
    yield range_line(range).center(width)
    yield ''
    yield fmt % ('Date', 'Particulars', 'Amount', 'DC', 'Account')
    yield fmt % ('-' * dw, '-' * pw, '-' * bw, '--', '-' * aw)
    def entry_fields(e):
        return (config.format_money(abs(e.amount)), ('db' if e.amount < 0 else 'cr'), chart.account(e.account).shortname())
    if bf:
        for e in bf.entries():
            yield fmt % (('',
                'Brought forward' + (' due ' + e.cdate.strftime(ur'%-d-%b-%Y') if e.cdate else ''),)
                + entry_fields(e))
    for t in transactions:
        desc = textwrap.wrap(t.description(), width=pw)
        entries = list(t.entries)
        yield fmt % ((t.date.strftime(ur'%_d-%b-%Y'), desc.pop(0)) + entry_fields(entries.pop(0)))
        while entries:
            yield fmt % (('', desc.pop(0) if desc else u'') + (entry_fields(entries.pop(0)) if entries else ('', '', '')))
        if opts['--wrap']:
            while desc:
                yield fmt % ('', desc.pop(0), '', '', '')
    yield fmt % ('-' * dw, '-' * pw, '-' * bw, '--', '-' * aw)

def cmd_chart(config, opts):
    typesel = (opts['AL'] or '').upper()
    if typesel == 'AL':
        pred = lambda a: a.atype == abo.account.AccountType.AssetLiability
    elif typesel == 'PL':
        pred = lambda a: a.atype == abo.account.AccountType.ProfitLoss
    elif typesel == 'EQ':
        pred = lambda a: a.atype == abo.account.AccountType.Equity
    elif typesel == '':
        pred = lambda a: True
    else:
        raise InvalidArg('invalid argument: %r' % (opts['AL'],))
    for account in get_chart(config, opts).accounts():
        if pred(account):
            yield unicode(account)

def cmd_index(config, opts):
    chart = get_chart(config, opts)
    return sorted(chart.iterkeys())

def cmd_compa(config, opts):
    word, preword = opts['<word>'], opts['<preword>']
    #print >>sys.stderr, 'word=%r preword=%r' % (word, preword),
    chart = get_chart(config, opts)
    keys = set()
    if preword not in ('--width',):
        for key in chart.iterkeys():
            if key.startswith(word) and len(key) > len(word):
                comp = key[len(word):]
                end = ''
                if ':' in comp:
                    comp = comp.split(':', 1)[0] + ':'
                else:
                    end = ' '
                keys.add(shell_quote(word + comp) + end)
    keys = sorted(keys)
    #print >>sys.stderr, ' keys=%r' % keys,
    return keys

def shell_quote(text):
    return (text.replace('\\', '\\\\')
                .replace('"', '\\"')
                .replace("'", "\\'")
                .replace('$', '\\$')
                .replace('`', '\\`')
                .replace(' ', '\\ '))

def cmd_acc(config, opts):
    chart = get_chart(config, opts)
    account = chart.account(opts['<account>'])
    range, bf, transactions = filter_period(chart, get_transactions(chart, config, opts), opts)
    dw = 11
    mw = config.money_column_width()
    bw = config.balance_column_width()
    if config.output_width():
        width = max(50, config.output_width())
        pw = max(1, width - (dw + 2 + 2 * (mw + 1) + 1 + bw))
    else:
        pw = 35
        width = dw + 2 + pw + 2 * (mw + 1) + 1 + bw
    fmt = u'%-{dw}.{dw}s  %-{pw}.{pw}s %{mw}s %{mw}s %{bw}s'.format(**locals())
    yield 'STATEMENT OF ACCOUNT'.center(width)
    yield range_line(range).center(width)
    yield ''
    yield fmt % ('Date', 'Particulars', 'Debit', 'Credit', 'Balance')
    yield fmt % ('-' * dw, '-' * pw, '-' * mw, '-' * mw, '-' * bw)
    balance = 0
    totdb = 0
    totcr = 0
    if bf:
        for e in bf.entries():
            if chart.account(e.account) in account:
                balance += e.amount
                yield fmt % ('', 'Brought forward' + (' due ' + e.cdate.strftime(ur'%-d-%b-%Y') if e.cdate else ''),
                        config.format_money(-e.amount) if e.amount < 0 else '',
                        config.format_money(e.amount) if e.amount > 0 else '',
                        config.format_money(balance))
    for t in transactions:
        for e in t.entries:
            if chart.account(e.account) in account:
                balance += e.amount
                if e.amount < 0:
                    totdb += e.amount
                elif e.amount > 0:
                    totcr += e.amount
                desc = textwrap.wrap(e.description(), width=pw)
                yield fmt % (e.transaction.date.strftime(ur'%_d-%b-%Y'),
                        desc.pop(0),
                        config.format_money(-e.amount) if e.amount < 0 else '',
                        config.format_money(e.amount) if e.amount > 0 else '',
                        config.format_money(balance))
                if opts['--wrap']:
                    while desc:
                        yield fmt % ('', desc.pop(0), '', '', '')
    yield fmt % ('-' * dw, '-' * pw, '-' * mw, '-' * mw, '-' * bw)
    yield fmt % ('', 'Totals for period',
            config.format_money(-totdb),
            config.format_money(totcr),
            '')
    yield fmt % ('', 'Balance', '', '', config.format_money(balance))

def cmd_profloss(config, opts):
    acc_pred = parse_account_predicate(opts)
    periods = parse_periods(opts)
    chart = get_chart(config, opts)
    transactions = get_transactions(chart, config, opts)
    sections = []
    all_accounts = set()
    for pred in ((lambda a, c, m: m > 0), (lambda a, c, m: m < 0)):
        bpred = lambda a, c, m: a.atype == abo.account.AccountType.ProfitLoss and (opts['--all'] or m) and acc_pred(a) and pred(a, c, m)
        balances = [abo.balance.Balance(chart, transactions, abo.balance.Range(p[0], p[1] + datetime.timedelta(1)), bpred) for p in periods]
        accounts = reduce(lambda x, y: x | y, (b.accounts for b in balances))
        sections.append(struct(balances=balances, accounts=accounts))
        all_accounts.update(accounts)
    bw = config.balance_column_width()
    aw = max(chain([10], (len(unicode(a)) for a in all_accounts)))
    width = (bw + 1) * len(balances) +  1 + aw
    if config.output_width() and width > config.output_width():
        aw = max(10, config.output_width() - ((bw + 1) * len(balances) + 1))
    fmt = (u'%{bw}s ' * len(balances) + u' %.{aw}s').format(**locals())
    yield 'PROFIT LOSS STATEMENT'.center(width)
    line = []
    for balance in balances:
        line.append(balance.date_range.start.strftime(ur'%_d-%b-%Y') if balance.date_range.start else '')
    line.append('')
    yield fmt % tuple(line)
    line = []
    for balance in balances:
        line.append((balance.date_range.end - datetime.timedelta(1)).strftime(ur'%_d-%b-%Y') if balance.date_range.end else '')
    line.append('Account')
    yield fmt % tuple(line)
    yield fmt % (('-' * bw,) * len(balances) + ('-' * aw,))
    for section in sections:
        for account in sorted(section.accounts, key=unicode):
            line = []
            for balance in section.balances:
                line.append(config.format_money(balance.balance(account)))
            line.append(unicode(account))
            yield fmt % tuple(line)
        yield fmt % (('-' * bw,) * len(section.balances) + ('-' * aw,))

def cmd_balance(config, opts):
    chart = get_chart(config, opts)
    all_transactions = get_transactions(chart, config, opts)
    when, balance, transactions = filter_at(chart, all_transactions, opts)
    bw = config.balance_column_width()
    aw = max(len(unicode(a)) for a in chart.accounts())
    width = bw + 2 + aw
    if config.output_width() and width > config.output_width():
        aw = max(10, config.output_width() - (bw + 2))
    fmt = u'%{bw}s  %.{aw}s'.format(**locals())
    yield 'ACCOUNT BALANCES'.center(width)
    yield when.strftime(ur'%_d-%b-%Y').center(width)
    yield ''
    yield fmt % ('Balance', 'Account')
    yield fmt % ('-' * bw, '-' * aw)
    for account in balance.accounts:
        bal = balance.balance(account)
        if bal or opts['--all']:
            yield fmt % (config.format_money(bal), unicode(account))
    yield fmt % ('-' * bw, '-' * aw)

def parse_account_predicate(opts):
    tag = opts['--tag']
    if not tag:
        return lambda a: True
    if tag.startswith('!'):
        return lambda a: tag[1:] not in a.tags
    return lambda a: tag in a.tags

def parse_periods(opts):
    brought_forward = None
    if opts['<period>']:
        periods = abo.period.parse_periods(opts['<period>'])
    else:
        periods = [(None, None)]
    return [(p[0], p[1] if p[1] is not None else datetime.date.today()) for p in periods]

def parse_range(words):
    periods = abo.period.parse_periods(words)
    if len(periods) > 1:
        raise ValueError('too many periods')
    return abo.balance.Range(*periods[0])

def filter_period(chart, transactions, opts):
    brought_forward = None
    if opts['<period>']:
        range = parse_range(opts['<period>'])
        if range.start is not None:
            brought_forward = abo.balance.Balance(chart, transactions, abo.balance.Range(None, range.start))
        transactions = [t for t in transactions if t.date in range]
    else:
        range = abo.balance.Range(None, None)
    return range, brought_forward, transactions

def filter_at(chart, transactions, opts):
    when = abo.period.parse_when(opts['<when>']) if opts['<when>'] else datetime.date.today()
    range = abo.balance.Range(None, when + datetime.timedelta(1))
    balance = abo.balance.Balance(chart, transactions, range)
    transactions = [t for t in transactions if t.date in range]
    return when, balance, transactions

def range_line(range):
    p = []
    if range.start is not None:
        p.append('FROM')
        p.append(range.start.strftime(ur'%_d-%b-%Y'))
    if range.end is not None:
        p.append('TO')
        p.append(range.end.strftime(ur'%_d-%b-%Y'))
    return ' '.join(p) if p else 'ALL DATES'

class InvalidArg(ValueError):
    pass

if __name__ == '__main__':
    main()

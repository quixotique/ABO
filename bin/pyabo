#!/usr/bin/env python2.7
# vim: sw=4 sts=4 et fileencoding=utf8 nomod
# Copyright 2013 Andrew Bettison

r'''Usage:
    pyabo chart [-fvqD] [--select=PRED]
    pyabo index [-fqD]
    pyabo acc [-bcfwWqD] [--remove=ACC...] [--width=COLUMNS] <PRED> [<period>...]
    pyabo journal [-fwWqD] [--remove=ACC...] [--width=COLUMNS] [<period>...]
    pyabo balance [-faWqD] [--select=PRED] [--remove=PRED...] [--width=COLUMNS] [<when>...]
    pyabo due [-fWqD] [--select=PRED] [--remove=PRED...] [--width=COLUMNS] [--detail] [<when>...]
    pyabo profloss [-fWqD] [--tax] [--select=PRED] [--remove=PRED...] [--width=COLUMNS] [<period>...]
    pyabo compa <command> <word> <preword>
    pyabo -h | --help
    pyabo --version

Options:
    -h --help               Show this message
    --version               Show version and exit
    -D --debug              Log debug on stderr
    -q --quiet              Suppress information logging on stderr
    -f --force              Force re-population of transaction cache
    --select=PRED           Only show accounts satisfying PRED
    -w --wrap               Wrap long lines
    --width=COLUMNS         Maximum line length (default from 'COLUMNS' env var)
    -W --wide               Wide output, no maximum width
    -a --all                Show all accounts
    -b --bring-forward      Bring balance of previous transactions forward
    -c --control            Show control account
    -d --detail             Show transaction details
    -v --verbose            Show more information
    -r --remove=ACC         Remove account ACC
    --tax                   Separate tax-free and tax-deductible sections

PRED = condition | disjunction
disjunction = conjunction "|" disjunction
conjunction = condition "&" conjunction
condition = "!" condition
condition = "=" TAG
condition = "/" GLOB
condition = ACC
'''

import sys
import logging
import locale
import os.path

try:
    import abo.config
except ImportError:
    sys.path.append(os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), '..', 'lib'))
    import abo.config

def main():
    global abo
    logging.basicConfig(stream=sys.stderr, level=logging.DEBUG)
    locale.setlocale(locale.LC_ALL, '')
    lang, enc = locale.getlocale()
    input_encoding = enc
    output_encoding = enc
    opts = None
    try:
        if len(sys.argv) >= 2 and sys.argv[1] == 'compa':
            pass
        else:
            try:
                import docopt
            except ImportError:
                sys.path.append(os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), '..', 'lib', 'docopt'))
                import docopt
            opts = docopt.docopt(__doc__, version='0.1')
        try:
            config = abo.config.Config().load()
        except abo.config.ConfigException, e:
            fatal(unicode(e).encode(output_encoding))
        if opts is None:
            output = compa(config, [arg.decode(input_encoding) for arg in sys.argv[2:]])
        else:
            if opts['<PRED>']:
                opts['<PRED>'] = opts['<PRED>'].decode(input_encoding)
            import abo.command
            for word, value in opts.iteritems():
                if type(value) is bool and value and hasattr(abo.command, 'cmd_' + word):
                    func = getattr(abo.command, 'cmd_' + word)
                    break
            else:
                fatal('unknown command : %s' % sys.argv[1])
            if opts['--debug'] or len(os.environ.get('PYABO_DEBUG', '')):
                pass
            elif opts['--quiet']:
                logging.disable(logging.INFO)
            else:
                logging.disable(logging.DEBUG)
            logging.debug("parsed options, func=%s", func.__name__)
            config.apply_options(opts)
            output = func(config, opts)
        for line in output:
            print line.encode(output_encoding)
    except:
        if opts and opts['--debug']:
            raise
        import abo.text
        import abo.command
        try:
            raise
        except abo.command.InvalidArg, e:
            fatal(unicode(e).encode(output_encoding))
        except abo.text.LineError, e:
            fatal(unicode(e).encode(output_encoding))
    sys.exit(0)

def fatal(message, status=1):
    print >>sys.stderr, "%s: %s" % (os.path.basename(sys.argv[0]), message)
    sys.exit(status)

def compa(config, args):
    logging.disable(logging.INFO)
    if len(args) != 3:
        import abo.command
        raise abo.command.InvalidArg("expecting exactly three arguments after 'compa'")
    command, word, preword = args
    logging.debug('command=%r word=%r preword=%r', command, word, preword)
    keys = set()
    if preword == 'pyabo':
        import abo.command
        for key, value in abo.command.__dict__.iteritems():
            if key.startswith('cmd_'):
                cmd = key[4:]
                if cmd.startswith(word) and len(cmd) > len(word) and type(value) is type(compa):
                    keys.add(cmd + ' ')
    elif preword == 'acc':
        keys.update(compa_pred(config, word))
    elif preword == '--select':
        keys.update(compa_pred(config, word))
    keys = sorted(keys)
    logging.debug('keys=%r', keys)
    return keys

def compa_accounts(config, word):
    import abo.cache
    chart = abo.cache.chart_cache(config).get()
    for key in chart.iterkeys():
        if key.startswith(word):
            comp = key[len(word):]
            end = ''
            if ':' in comp:
                comp = comp.split(':', 1)[0] + ':'
            else:
                end = ' '
            yield shell_quote(word + comp) + end

def compa_tags(config, word):
    import abo.cache
    chart = abo.cache.chart_cache(config).get()
    for tag in chart.tags():
        if tag.startswith(word):
            yield shell_quote(tag) + ' '

def compa_pred(config, word):
    if word.startswith('='):
        for comp in compa_tags(config, word[1:]):
            yield '=' + comp
    elif word.startswith('/'):
        pass
    else:
        if word == '':
            yield '='
            yield '/'
        for comp in compa_accounts(config, word):
            yield comp

def shell_quote(text):
    return (text.replace('\\', '\\\\')
                .replace('"', '\\"')
                .replace("'", "\\'")
                .replace('$', '\\$')
                .replace('`', '\\`')
                .replace(' ', '\\ '))

if __name__ == '__main__':
    main()
